name: Package Release

on:
  release:
    types: [published]

jobs:
  package:
    name: Create release packages
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build distributions
        run: python -m build

      - name: Create source zip
        run: |
          mkdir -p release-artifacts
          zip -r release-artifacts/skillmeat-source.zip skillmeat/ pyproject.toml README.md LICENSE MANIFEST.in -x "*/.*" "*/__pycache__/*" "*.egg-info/*"

      - name: Create distribution zip
        run: |
          mkdir -p release-artifacts/dist
          cp dist/* release-artifacts/dist/
          cd release-artifacts
          zip -r skillmeat-distributions.zip dist/

      - name: Create comprehensive release package
        run: |
          mkdir -p skillmeat-release
          cp -r skillmeat/ skillmeat-release/
          cp pyproject.toml README.md LICENSE MANIFEST.in skillmeat-release/
          cd skillmeat-release
          zip -r ../release-artifacts/skillmeat-${{ github.event.release.tag_name }}-full.zip .

      - name: Create standalone CLI package (Windows)
        run: |
          python -m pip install pyinstaller
          pyinstaller --onefile --name skillmeat --distpath release-artifacts/standalone-windows skillmeat/cli.py
        continue-on-error: true

      - name: Create standalone CLI package (macOS)
        run: |
          python -m pip install pyinstaller
          pyinstaller --onefile --name skillmeat --distpath release-artifacts/standalone-macos skillmeat/cli.py
        continue-on-error: true

      - name: Create standalone CLI package (Linux)
        run: |
          python -m pip install pyinstaller
          pyinstaller --onefile --name skillmeat --distpath release-artifacts/standalone-linux skillmeat/cli.py
        continue-on-error: true

      - name: Generate checksums
        run: |
          cd release-artifacts
          find . -type f ! -name "*.zip" ! -path "*/standalone-*" -exec sha256sum {} \; > CHECKSUMS.txt

      - name: Generate release manifest
        run: |
          cat > release-artifacts/MANIFEST.txt << 'EOF'
          SkillMeat Release: ${{ github.event.release.tag_name }}
          Released: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          Distribution Files:
          - skillmeat-${{ github.event.release.tag_name }}-full.zip: Complete package with documentation
          - skillmeat-source.zip: Source code only
          - skillmeat-distributions.zip: Python distributions (wheel + source)
          - dist/skillmeat-*.whl: Python wheel (install with pip)
          - dist/skillmeat-*.tar.gz: Python source distribution (install with pip)

          Installation:

          Recommended (uv):
            uv tool install skillmeat

          Alternative (pip):
            pip install skillmeat

          From source:
            pip install dist/skillmeat-*.whl

          Standalone (if available):
            Windows: Use standalone-windows/skillmeat.exe
            macOS: Use standalone-macos/skillmeat
            Linux: Use standalone-linux/skillmeat

          Verification:
            sha256sum -c CHECKSUMS.txt

          For more information, see README.md or PUBLISHING.md
          EOF

      - name: List release artifacts
        run: |
          echo "Release artifacts created:"
          ls -lh release-artifacts/

      - name: Upload artifacts to release
        uses: softprops/action-gh-release@v1
        if: github.event_name == 'release'
        with:
          files: |
            release-artifacts/skillmeat-source.zip
            release-artifacts/skillmeat-distributions.zip
            release-artifacts/skillmeat-${{ github.event.release.tag_name }}-full.zip
            release-artifacts/CHECKSUMS.txt
            release-artifacts/MANIFEST.txt
            dist/skillmeat-*.whl
            dist/skillmeat-*.tar.gz
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts for inspection
        uses: actions/upload-artifact@v4
        with:
          name: release-packages
          path: release-artifacts/
          retention-days: 30
